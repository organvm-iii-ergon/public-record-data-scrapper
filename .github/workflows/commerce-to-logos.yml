name: Commerce → Logos

# When an issue is labeled 'publish-process', dispatches commerce.publish-requested
# to ORGAN-IV to initiate the essay creation pipeline in ORGAN-V.

on:
  issues:
    types: [labeled]

jobs:
  dispatch-publish:
    if: github.event.label.name == 'publish-process'
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Check for existing orchestration issue
        id: check
        env:
          GH_TOKEN: ${{ secrets.ORCHESTRATION_PAT || secrets.GITHUB_TOKEN }}
          REPO_FULL: ${{ github.repository }}
          ISSUE_NUM: ${{ github.event.issue.number }}
        run: |
          SEARCH_TITLE="Publish: ${REPO_FULL}#${ISSUE_NUM}"
          EXISTING=$(gh issue list \
            --repo organvm-iv-taxis/orchestration-start-here \
            --search "${SEARCH_TITLE} in:title" \
            --state open --json title --limit 3 2>/dev/null || echo "[]")

          if echo "$EXISTING" | python3 -c "import sys,json; issues=json.load(sys.stdin); sys.exit(0 if any('Publish:' in i.get('title','') for i in issues) else 1)" 2>/dev/null; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Dispatch commerce.publish-requested
        if: steps.check.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.ORCHESTRATION_PAT || secrets.GITHUB_TOKEN }}
          REPO_FULL: ${{ github.repository }}
          ISSUE_NUM: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          PAYLOAD=$(python3 -c "
          import json, os
          print(json.dumps({
              'source_repo': os.environ['REPO_FULL'],
              'source_organ': 'ORGAN-III',
              'target_organ': 'ORGAN-V',
              'promotion_type': 'publish-process',
              'issue_number': os.environ['ISSUE_NUM'],
              'issue_title': os.environ['ISSUE_TITLE'],
              'triggered_by': 'commerce-to-logos',
          }))
          ")

          gh api repos/organvm-iv-taxis/orchestration-start-here/dispatches \
            --method POST \
            -f event_type=commerce.publish-requested \
            -f "client_payload=${PAYLOAD}"

          echo "Dispatched commerce.publish-requested for ${REPO_FULL}#${ISSUE_NUM}"

      - name: Comment on issue
        if: steps.check.outputs.exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `**Publish process initiated.**\n\nA \`commerce.publish-requested\` event has been dispatched to ORGAN-IV orchestration.\n\nThe essay creation pipeline will generate a draft in ORGAN-V (public-process).\n\n---\n*Generated by commerce-to-logos workflow*`
            });

      - name: Already tracked
        if: steps.check.outputs.exists == 'true'
        run: echo "Orchestration issue already exists — skipping dispatch"
